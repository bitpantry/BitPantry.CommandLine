# Implementation Tasks: Flexible Internal Package Version Management

**Branch**: `007-flex-version-mgmt` | **Date**: 2026-01-01 | **Spec**: [spec.md](spec.md) | **Plan**: [plan.md](plan.md)

**Note**: This task list was generated by `/speckit.tasks` from the implementation plan.

## Task Organization

Tasks are grouped by User Story priority to enable independent implementation and testing. Complete P1 stories first as they form the foundation for P2/P3 stories.

**Priority Order**:
- **P1 (Foundation)**: US0 (CPM), US1 (Minor/Patch), US7 (Cascade), US9 (Unified Workflow)
- **P2 (Enhancement)**: US2-4, US6 (Release Agent)
- **P3 (Optimization)**: US5, US8

---

## Phase 1: Foundation Infrastructure

### US0 - Adopt Central Package Management (P1)

- [x] [T001] [P1] [US0] Create `Directory.Packages.props` at solution root with `<ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>` — [Directory.Packages.props](../../Directory.Packages.props)
- [x] [T002] [P1] [US0] Add `<PackageVersion>` entries for all external dependencies with exact versions (from data-model.md external dependencies table) — [Directory.Packages.props](../../Directory.Packages.props)
- [x] [T003] [P1] [US0] Add `<PackageVersion>` entries for internal dependencies with version ranges: `BitPantry.CommandLine [5.0.0, 6.0.0)`, `BitPantry.CommandLine.Remote.SignalR [1.0.0, 2.0.0)` — [Directory.Packages.props](../../Directory.Packages.props)
- [x] [T004] [P1] [US0] Update `BitPantry.CommandLine.csproj` to remove `Version` attribute from all `<PackageReference>` elements — [BitPantry.CommandLine/BitPantry.CommandLine.csproj](../../BitPantry.CommandLine/BitPantry.CommandLine.csproj)
- [x] [T005] [P1] [US0] Update `BitPantry.CommandLine.Remote.SignalR.csproj` to remove `Version` attribute from all `<PackageReference>` elements — [BitPantry.CommandLine.Remote.SignalR/BitPantry.CommandLine.Remote.SignalR.csproj](../../BitPantry.CommandLine.Remote.SignalR/BitPantry.CommandLine.Remote.SignalR.csproj)
- [x] [T006] [P1] [US0] Update `BitPantry.CommandLine.Remote.SignalR.Client.csproj` to remove `Version` attribute from all `<PackageReference>` elements — [BitPantry.CommandLine.Remote.SignalR.Client/BitPantry.CommandLine.Remote.SignalR.Client.csproj](../../BitPantry.CommandLine.Remote.SignalR.Client/BitPantry.CommandLine.Remote.SignalR.Client.csproj)
- [x] [T007] [P1] [US0] Update `BitPantry.CommandLine.Remote.SignalR.Server.csproj` to remove `Version` attribute from all `<PackageReference>` elements — [BitPantry.CommandLine.Remote.SignalR.Server/BitPantry.CommandLine.Remote.SignalR.Server.csproj](../../BitPantry.CommandLine.Remote.SignalR.Server/BitPantry.CommandLine.Remote.SignalR.Server.csproj)
- [x] [T008] [P1] [US0] Update test project .csproj files to remove `Version` attributes from `<PackageReference>` elements — [BitPantry.CommandLine.Tests/](../../BitPantry.CommandLine.Tests/), [BitPantry.CommandLine.Tests.Remote.SignalR/](../../BitPantry.CommandLine.Tests.Remote.SignalR/)
- [x] [T009] [P1] [US0] Verify solution builds successfully with `dotnet build` after CPM migration
- [x] [T010] [P1] [US0] Verify `dotnet restore` resolves all packages correctly with centralized versions

### US9 - Unified Release Workflow (P1)

- [x] [T011] [P1] [US9] Create `.github/workflows/release-unified.yml` with trigger on `release-v*` tags — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T012] [P1] [US9] Implement `publish-core` job with version detection (compare .csproj version vs NuGet API) — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T013] [P1] [US9] Implement `publish-signalr` job with `needs: [publish-core]` dependency and NuGet polling step — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T014] [P1] [US9] Implement `publish-client` job with `needs: [publish-signalr]` dependency and NuGet polling step — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T015] [P1] [US9] Implement `publish-server` job with `needs: [publish-signalr]` dependency and NuGet polling step — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T016] [P1] [US9] Implement `create-release` job with `needs: [publish-core, publish-signalr, publish-client, publish-server]` that creates GitHub Release with auto-generated notes — [.github/workflows/release-unified.yml](../../.github/workflows/release-unified.yml)
- [x] [T017] [P1] [US9] Configure NuGet availability polling with 30-second intervals and 15-minute timeout in all dependent jobs
- [x] [T018] [P1] [US9] Add job outputs for `published` and `version` to enable downstream jobs to detect upstream publish status
- [x] [T019] [P1] [US9] Add conditional polling logic: only poll when upstream job actually published (not when skipped)

### US1 - Minor/Patch Without Downstream Releases (P1)

- [x] [T020] [P1] [US1] Document Core-only release verification steps in quickstart.md (manual: change Core version, push tag, confirm downstream jobs skip)
- [x] [T021] [P1] [US1] Document how to inspect generated .nupkg for version range metadata in internal dependencies — [specs/007-flex-version-mgmt/quickstart.md](quickstart.md)
- [x] [T022] [P1] [US1] Document minor/patch release workflow in quickstart.md — [specs/007-flex-version-mgmt/quickstart.md](quickstart.md)

### US7 - Breaking Change Cascade Management (P1)

- [x] [T023] [P1] [US7] Document cascade detection logic in agent file: when major version bump detected, identify all downstream packages
- [x] [T024] [P1] [US7] Document cascade matrix in data-model.md with version range update rules — [specs/007-flex-version-mgmt/data-model.md](data-model.md)
- [x] [T025] [P1] [US7] Document full cascade verification steps in quickstart.md (manual: Core 5.x → 6.0.0, expected publish order)

---

## Phase 2: Release Agent

### US6 - Automated Release Planning Tool (P2)

- [x] [T026] [P2] [US6] Create `.claude/commands/speckit.bp.release.md` agent command file — [.claude/commands/speckit.bp.release.md](../../.claude/commands/speckit.bp.release.md)
- [x] [T027] [P2] [US6] Implement NuGet version query logic: query `https://api.nuget.org/v3-flatcontainer/{package-id}/index.json` for latest version
- [x] [T028] [P2] [US6] Implement change detection: compare HEAD against commit where current .csproj version was set using `git log`
- [x] [T029] [P2] [US6] Implement rich change summary: commit count, commit messages, files changed with diff stats, public API file flagging (FR-016a, FR-016b, FR-016c)
- [x] [T030] [P2] [US6] Implement release plan table generation: package name, current version, proposed version, change summary, rationale
- [x] [T031] [P2] [US6] Implement user confirmation workflow: display plan, await confirmation/modification/rejection
- [x] [T032] [P2] [US6] Implement version update execution: update .csproj files and Directory.Packages.props
- [x] [T033] [P2] [US6] Document atomic commit workflow in agent file: stage all changes, commit with descriptive message, create `release-v{timestamp}` tag
- [x] [T034] [P2] [US6] Document tag push workflow in agent file: push commit and tag together to trigger unified workflow, output GitHub Actions URL for monitoring
- [x] [T035] [P2] [US6] Document complete dependency graph and publishing order in agent file (FR-040)
- [x] [T036] [P2] [US6] Document NuGet polling mechanism in agent file: endpoint, interval, timeout (FR-041)
- [x] [T037] [P2] [US6] Document error handling and recovery procedures in agent file (FR-042)
- [x] [T038] [P2] [US6] Document cascade detection and version range update logic in agent file

### US2 - Breaking Change Coordination (P2)

- [x] [T039] [P2] [US2] Document verification steps for major version bounds (downstream packages with `[5.0.0, 6.0.0)` should not auto-use 6.x)
- [x] [T040] [P2] [US2] Document NuGet version resolution behavior for incompatible version ranges

### US3 - Third-Party Dependencies Remain Pinned (P2)

- [x] [T041] [P2] [US3] Verify external dependencies in Directory.Packages.props use exact versions (no ranges)
- [x] [T042] [P2] [US3] Verify generated .nupkg shows exact versions for external dependencies in nuspec

### US4 - Local Development Experience Unchanged (P2)

- [x] [T043] [P2] [US4] Verify `UseProjectReferences=true` still uses project references after CPM adoption
- [x] [T044] [P2] [US4] Verify `UseProjectReferences=false` uses package references with version ranges from Directory.Packages.props
- [x] [T045] [P2] [US4] Document local development workflow verification (change Core, build downstream, confirm immediate reflection)

---

## Phase 3: Validation & Optimization

### US5 - CI/CD Version Validation (P3)

- [x] [T046] [P3] [US5] Add pre-publish validation step in unified workflow: check referenced internal package versions exist on NuGet
- [x] [T047] [P3] [US5] Implement clear error message when internal dependency version is missing
- [x] [T048] [P3] [US5] Document validation failure scenario verification (reference non-existent internal package version)

### US8 - Selective Breaking Change Scope (P3)

- [x] [T049] [P3] [US8] Add `--cascade-scope` parameter support to release agent for selective cascade
- [x] [T050] [P3] [US8] Implement warning when packages excluded from cascade
- [x] [T051] [P3] [US8] Document selective scope usage in agent file

---

## Phase 4: Cleanup & Documentation

### Deprecation

- [x] [T052] [P2] Add deprecation notice header to `build-core.yml`: "DEPRECATED: Use release-unified.yml" — [.github/workflows/build-core.yml](../../.github/workflows/build-core.yml)
- [x] [T053] [P2] Add deprecation notice header to `build-client.yml`: "DEPRECATED: Use release-unified.yml" — [.github/workflows/build-client.yml](../../.github/workflows/build-client.yml)
- [x] [T054] [P2] Add deprecation notice header to `build-server.yml`: "DEPRECATED: Use release-unified.yml" — [.github/workflows/build-server.yml](../../.github/workflows/build-server.yml)
- [x] [T055] [P2] Add deprecation notice header to `build-remote-signalr.yml`: "DEPRECATED: Use release-unified.yml" — [.github/workflows/build-remote-signalr.yml](../../.github/workflows/build-remote-signalr.yml)

### Documentation

- [x] [T056] [P2] Update CLAUDE.md with CPM and unified workflow context — [CLAUDE.md](../../CLAUDE.md)
- [x] [T057] [P2] Update quickstart.md with complete release scenarios and version range usage guidance (FR-009) — [specs/007-flex-version-mgmt/quickstart.md](quickstart.md)
- [x] [T058] [P2] Verify release agent documentation is self-contained per FR-043 (new developer can understand system)

---

## Task Summary

| Priority | Story | Task Count |
|----------|-------|------------|
| P1 | US0 - CPM Adoption | 10 |
| P1 | US9 - Unified Workflow | 9 |
| P1 | US1 - Minor/Patch | 3 |
| P1 | US7 - Cascade Management | 3 |
| P2 | US6 - Release Agent | 13 |
| P2 | US2-4 | 7 |
| P2 | Deprecation | 4 |
| P2 | Documentation | 3 |
| P3 | US5 - CI/CD Validation | 3 |
| P3 | US8 - Selective Scope | 3 |
| **Total** | | **58** |

---

## Verification Checklist

After completing all tasks, verify:

- [ ] Solution builds with `dotnet build` (CPM working)
- [ ] All tests pass with `dotnet test`
- [ ] Release agent produces correct plan output (dry run only)
- [ ] New developer can understand release system from agent docs

**Manual Release Verification** (to be done by maintainer when ready):
- Core-only release works (downstream packages skip)
- Full cascade release works (all packages publish in order)
- GitHub Release created with package summary
