{
  "taskId": "T054",
  "testCase": "",
  "green": {
    "timestamp": "2026-02-04T18:38:48.5422355-06:00",
    "testCommand": "",
    "exitCode": 0,
    "output": ""
  },
  "diff": {
    "timestamp": "2026-02-04T18:38:48.5422355-06:00",
    "files": [
      "BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs",
      "BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/ProfileManagerTests.cs",
      "specs/009-server-profile/batch-state.json",
      "specs/009-server-profile/batches/batch-003.md",
      "specs/009-server-profile/batches/batch-004.md"
    ],
    "patch": "diff --git a/BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs b/BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs\nindex 1624a1f..a15d528 100644\n--- a/BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs\n+++ b/BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs\n@@ -67,9 +67,21 @@ public class ProfileManager : IProfileManager\n         if (string.IsNullOrWhiteSpace(profile.Name))\n             throw new ArgumentException(\"Profile name cannot be empty\", nameof(profile));\n         \n+        // Validate profile name length (max 64 characters)\n+        if (profile.Name.Length > 64)\n+            throw new ArgumentException(\"Profile name cannot exceed 64 characters\", nameof(profile));\n+        \n+        // Validate profile name doesn't start with hyphen\n+        if (profile.Name.StartsWith('-'))\n+            throw new ArgumentException(\"Profile name cannot start with a hyphen\", nameof(profile));\n+        \n         // Validate profile name contains only allowed characters (letters, digits, hyphens, underscores)\n         if (!IsValidProfileName(profile.Name))\n             throw new ArgumentException(\"Profile name contains invalid characters. Only letters, digits, hyphens, and underscores are allowed.\", nameof(profile));\n+        \n+        // Validate URI is well-formed\n+        if (string.IsNullOrWhiteSpace(profile.Uri) || !Uri.TryCreate(profile.Uri, UriKind.Absolute, out _))\n+            throw new ArgumentException(\"Profile URI is invalid or malformed\", nameof(profile));\n \n         var config = await LoadConfigurationAsync(ct);\n         \n@@ -193,21 +205,29 @@ public class ProfileManager : IProfileManager\n         if (!_fileSystem.File.Exists(_configFilePath))\n             return new ProfileConfiguration();\n \n-        var json = await _fileSystem.File.ReadAllTextAsync(_configFilePath, ct);\n-        var config = JsonSerializer.Deserialize<ProfileConfiguration>(json, _jsonOptions) ?? new ProfileConfiguration();\n-        \n-        // Ensure dictionary uses case-insensitive comparison (JSON deserialization loses the custom comparer)\n-        if (config.Profiles.Count > 0)\n+        try\n         {\n-            var profiles = new Dictionary<string, ServerProfile>(StringComparer.OrdinalIgnoreCase);\n-            foreach (var kvp in config.Profiles)\n+            var json = await _fileSystem.File.ReadAllTextAsync(_configFilePath, ct);\n+            var config = JsonSerializer.Deserialize<ProfileConfiguration>(json, _jsonOptions) ?? new ProfileConfiguration();\n+            \n+            // Ensure dictionary uses case-insensitive comparison (JSON deserialization loses the custom comparer)\n+            if (config.Profiles.Count > 0)\n             {\n-                profiles[kvp.Key] = kvp.Value;\n+                var profiles = new Dictionary<string, ServerProfile>(StringComparer.OrdinalIgnoreCase);\n+                foreach (var kvp in config.Profiles)\n+                {\n+                    profiles[kvp.Key] = kvp.Value;\n+                }\n+                config.Profiles = profiles;\n             }\n-            config.Profiles = profiles;\n+            \n+            return config;\n+        }\n+        catch (JsonException)\n+        {\n+            // Corrupted file - return empty configuration (will be overwritten on next save)\n+            return new ProfileConfiguration();\n         }\n-        \n-        return config;\n     }\n \n     private async Task SaveConfigurationAsync(ProfileConfiguration config, CancellationToken ct)\ndiff --git a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/ProfileManagerTests.cs b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/ProfileManagerTests.cs\nindex 25d4adb..80d505a 100644\n--- a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/ProfileManagerTests.cs\n+++ b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/ProfileManagerTests.cs\n@@ -395,6 +395,125 @@ namespace BitPantry.CommandLine.Tests.Remote.SignalR.ClientTests\n                 .WithMessage(\"*invalid*character*\");\n         }\n \n+        [TestMethod]\n+        public async Task CreateProfile_TooLongName_ThrowsValidation()\n+        {\n+            // Arrange\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+            var longName = new string('a', 65); // 65 chars exceeds 64 char limit\n+            var profile = new ServerProfile { Name = longName, Uri = \"https://example.com\" };\n+\n+            // Act\n+            Func<Task> act = async () => await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            await act.Should().ThrowAsync<ArgumentException>()\n+                .WithMessage(\"*64*characters*\");\n+        }\n+\n+        [TestMethod]\n+        public async Task CreateProfile_HyphenInName_Succeeds()\n+        {\n+            // Arrange\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+            var profile = new ServerProfile { Name = \"my-profile\", Uri = \"https://example.com\" };\n+\n+            // Act\n+            await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            var retrieved = await profileManager.GetProfileAsync(\"my-profile\");\n+            retrieved.Should().NotBeNull(\"hyphen in middle of name should be allowed\");\n+            retrieved!.Name.Should().Be(\"my-profile\");\n+        }\n+\n+        [TestMethod]\n+        public async Task CreateProfile_StartsWithHyphen_ThrowsValidation()\n+        {\n+            // Arrange\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+            var profile = new ServerProfile { Name = \"-profile\", Uri = \"https://example.com\" };\n+\n+            // Act\n+            Func<Task> act = async () => await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            await act.Should().ThrowAsync<ArgumentException>()\n+                .WithMessage(\"*cannot start with*hyphen*\");\n+        }\n+\n+        [TestMethod]\n+        public async Task CreateProfile_InvalidUri_ThrowsValidation()\n+        {\n+            // Arrange\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+            var profile = new ServerProfile { Name = \"production\", Uri = \"not-a-valid-uri\" };\n+\n+            // Act\n+            Func<Task> act = async () => await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            await act.Should().ThrowAsync<ArgumentException>()\n+                .WithMessage(\"*URI*invalid*\");\n+        }\n+\n+        #endregion\n+\n+        #region Edge Case Tests\n+\n+        [TestMethod]\n+        public async Task CreateProfile_CorruptedFile_RecreatesFile()\n+        {\n+            // Arrange - Create corrupted profiles.json\n+            var configPath = _fileSystem.Path.Combine(_storagePath, \"profiles.json\");\n+            _fileSystem.File.WriteAllText(configPath, \"{ this is not valid json }\");\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+\n+            // Act - Should recreate file and add profile successfully\n+            var profile = new ServerProfile { Name = \"production\", Uri = \"https://example.com\" };\n+            await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            var retrieved = await profileManager.GetProfileAsync(\"production\");\n+            retrieved.Should().NotBeNull(\"corrupted file should be recreated to allow new profile\");\n+        }\n+\n+        [TestMethod]\n+        public async Task GetAllProfiles_MissingFile_ReturnsEmpty()\n+        {\n+            // Arrange - Ensure no profiles.json exists\n+            var configPath = _fileSystem.Path.Combine(_storagePath, \"profiles.json\");\n+            if (_fileSystem.File.Exists(configPath))\n+                _fileSystem.File.Delete(configPath);\n+            var profileManager = new ProfileManager(_fileSystem, _storagePath, _credentialStore);\n+\n+            // Act\n+            var profiles = await profileManager.GetAllProfilesAsync();\n+\n+            // Assert\n+            profiles.Should().BeEmpty(\"missing file should return empty list, not throw\");\n+        }\n+\n+        [TestMethod]\n+        public async Task CreateProfile_DirectoryNotExists_CreatesDirectory()\n+        {\n+            // Arrange - Use a path where directory doesn't exist\n+            var newPath = @\"C:\\Users\\TestUser\\.bitpantry\\commandline\\newprofiles\";\n+            // Ensure directory doesn't exist\n+            if (_fileSystem.Directory.Exists(newPath))\n+                _fileSystem.Directory.Delete(newPath, true);\n+            var profileManager = new ProfileManager(_fileSystem, newPath, _credentialStore);\n+\n+            // Act\n+            var profile = new ServerProfile { Name = \"production\", Uri = \"https://example.com\" };\n+            await profileManager.CreateProfileAsync(profile);\n+\n+            // Assert\n+            _fileSystem.Directory.Exists(newPath).Should().BeTrue(\"directory should be created\");\n+            var retrieved = await profileManager.GetProfileAsync(\"production\");\n+            retrieved.Should().NotBeNull(\"profile should be saved in newly created directory\");\n+        }\n+\n         #endregion\n     }\n }\ndiff --git a/specs/009-server-profile/batch-state.json b/specs/009-server-profile/batch-state.json\nindex 142941a..c4e9f2e 100644\n--- a/specs/009-server-profile/batch-state.json\n+++ b/specs/009-server-profile/batch-state.json\n@@ -1,5 +1,5 @@\n {\n-  \"activeBatch\": \"batch-003\",\n+  \"activeBatch\": \"batch-004\",\n   \"currentTask\": null,\n   \"taskStates\": {\n     \"T139\": {\n@@ -19,10 +19,14 @@\n       \"verifiedAt\": \"2026-02-04T17:35:24.472724-06:00\"\n     },\n     \"T051\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:47.3611878-06:00\"\n     },\n     \"T053\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:48.3973104-06:00\"\n     },\n     \"T099\": {\n       \"phase\": \"pending\"\n@@ -47,7 +51,9 @@\n       \"phase\": \"pending\"\n     },\n     \"T052\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:47.9153231-06:00\"\n     },\n     \"T082\": {\n       \"phase\": \"pending\"\n@@ -184,7 +190,9 @@\n       \"phase\": \"pending\"\n     },\n     \"T050\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:46.94346-06:00\"\n     },\n     \"T098\": {\n       \"phase\": \"pending\"\n@@ -238,7 +246,9 @@\n       \"phase\": \"pending\"\n     },\n     \"T049\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:41.909676-06:00\"\n     },\n     \"T076\": {\n       \"phase\": \"pending\"\n@@ -275,7 +285,9 @@\n       \"phase\": \"pending\"\n     },\n     \"T048\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-02-04T18:38:37.5670609-06:00\"\n     },\n     \"T091\": {\n       \"phase\": \"pending\"\n@@ -330,7 +342,7 @@\n     \"T047\": {\n       \"phase\": \"verified\",\n       \"status\": \"verified\",\n-      \"verifiedAt\": \"2026-02-04T18:29:07.7497920-06:00\"\n+      \"verifiedAt\": \"2026-02-04T18:29:07.749792-06:00\"\n     },\n     \"T090\": {\n       \"phase\": \"pending\"\n@@ -399,7 +411,8 @@\n   \"batchStatus\": \"pending\",\n   \"completedBatches\": [\n     \"batch-001\",\n-    \"batch-002\"\n+    \"batch-002\",\n+    \"batch-003\"\n   ],\n   \"totalBatches\": 9,\n   \"created\": \"2026-02-04T17:32:30.9711216-06:00\"\ndiff --git a/specs/009-server-profile/batches/batch-003.md b/specs/009-server-profile/batches/batch-003.md\nindex ee3bcbc..c7119ae 100644\n--- a/specs/009-server-profile/batches/batch-003.md\n+++ b/specs/009-server-profile/batches/batch-003.md\n@@ -1,7 +1,7 @@\n # Batch 3: server-profile\n \n **Created**: 2026-02-04\n-**Status**: in-progress\n+**Status**: complete\n **Tasks**: 14 of 17 complete\n \n ## Tasks\n@@ -37,3 +37,4 @@\n \n \n \n+\ndiff --git a/specs/009-server-profile/batches/batch-004.md b/specs/009-server-profile/batches/batch-004.md\nindex 0943721..0c94850 100644\n--- a/specs/009-server-profile/batches/batch-004.md\n+++ b/specs/009-server-profile/batches/batch-004.md\n@@ -1,16 +1,16 @@\n # Batch 4: server-profile\n \n **Created**: 2026-02-04\n-**Status**: pending\n-**Tasks**: 0 of 12 complete\n+**Status**: in-progress\n+**Tasks**: 6 of 15 complete\n \n ## Tasks\n-- [ ] T048 [depends:T003] @test-case:009:PM-032 Test CreateProfile_TooLongName_ThrowsValidation in ProfileManagerTests.cs\n-- [ ] T049 [depends:T003] @test-case:009:PM-033 Test CreateProfile_HyphenInName_Succeeds in ProfileManagerTests.cs\n-- [ ] T050 [depends:T003] @test-case:009:PM-034 Test CreateProfile_StartsWithHyphen_ThrowsValidation in ProfileManagerTests.cs\n-- [ ] T051 [depends:T003] @test-case:009:PM-035 Test CreateProfile_InvalidUri_ThrowsValidation in ProfileManagerTests.cs\n-- [ ] T052 [depends:T003] @test-case:009:PM-040 Test CreateProfile_CorruptedFile_RecreatesFile in ProfileManagerTests.cs\n-- [ ] T053 [depends:T003] @test-case:009:PM-041 Test GetAllProfiles_MissingFile_ReturnsEmpty in ProfileManagerTests.cs\n+- [X] T048 [depends:T003] @test-case:009:PM-032 Test CreateProfile_TooLongName_ThrowsValidation in ProfileManagerTests.cs\n+- [X] T049 [depends:T003] @test-case:009:PM-033 Test CreateProfile_HyphenInName_Succeeds in ProfileManagerTests.cs\n+- [X] T050 [depends:T003] @test-case:009:PM-034 Test CreateProfile_StartsWithHyphen_ThrowsValidation in ProfileManagerTests.cs\n+- [X] T051 [depends:T003] @test-case:009:PM-035 Test CreateProfile_InvalidUri_ThrowsValidation in ProfileManagerTests.cs\n+- [X] T052 [depends:T003] @test-case:009:PM-040 Test CreateProfile_CorruptedFile_RecreatesFile in ProfileManagerTests.cs\n+- [X] T053 [depends:T003] @test-case:009:PM-041 Test GetAllProfiles_MissingFile_ReturnsEmpty in ProfileManagerTests.cs\n - [ ] T054 [depends:T003] @test-case:009:PM-042 Test CreateProfile_DirectoryNotExists_CreatesDirectory in ProfileManagerTests.cs\n - [ ] T055 [depends:T022,T030,T031,T032,T033,T034,T035,T036,T037,T038,T039,T040,T041,T042,T043,T044,T045,T046,T047,T048,T049,T050,T051,T052,T053,T054] @test-case:009:IMPL-PM Implement ProfileManager in Profiles/ProfileManager.cs\n - [ ] T060 [depends:T055] @test-case:009:AC-001 Test GetOptions_NoProfiles_ReturnsEmpty in ProfileNameProviderTests.cs\n@@ -23,3 +23,9 @@\n - [ ] All tasks verified (evidence validated)\n - [ ] Full test suite passes (5 consecutive clean runs)\n - [ ] No open ambiguities\n+\n+\n+\n+\n+\n+"
  }
}
