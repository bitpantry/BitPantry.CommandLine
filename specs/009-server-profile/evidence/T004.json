{
  "taskId": "T004",
  "testCase": "",
  "green": {
    "timestamp": "2026-02-04T17:34:56.1609653-06:00",
    "testCommand": "",
    "exitCode": 0,
    "output": ""
  },
  "diff": {
    "timestamp": "2026-02-04T17:34:56.1609653-06:00",
    "files": [
      "specs/009-server-profile/research.md",
      "specs/009-server-profile/spec.md",
      "specs/009-server-profile/tasks.md",
      "specs/009-server-profile/test-cases.md"
    ],
    "patch": "diff --git a/specs/009-server-profile/research.md b/specs/009-server-profile/research.md\nindex 09e8883..b96f381 100644\n--- a/specs/009-server-profile/research.md\n+++ b/specs/009-server-profile/research.md\n@@ -124,10 +124,58 @@ string apiKey = Encoding.UTF8.GetString(decrypted);\n **Decision**: Implement `IAutoCompleteHandler` for profile name suggestions.\n \n **Rationale**:\n-- Existing pattern used throughout codebase (EnvironmentHandler, FilePathHandler, etc.)\n+- Existing pattern established in spec 008-autocomplete-extensions\n - Spec requires autocomplete support (FR-008.1)\n - Simple implementation based on `IProfileManager.GetAllProfilesAsync()`\n \n+**Implementation Pattern** (from 008 refactors):\n+\n+```csharp\n+// ProfileNameProvider.cs - implements the handler interface\n+public class ProfileNameProvider : IAutoCompleteHandler\n+{\n+    private readonly IProfileManager _profileManager;\n+    \n+    public ProfileNameProvider(IProfileManager profileManager)\n+    {\n+        _profileManager = profileManager;\n+    }\n+    \n+    public async Task<List<AutoCompleteOption>> GetOptionsAsync(\n+        AutoCompleteContext context,\n+        CancellationToken cancellationToken = default)\n+    {\n+        var profiles = await _profileManager.GetAllProfilesAsync(cancellationToken);\n+        var defaultName = await _profileManager.GetDefaultProfileNameAsync(cancellationToken);\n+        var query = context.QueryString ?? string.Empty;\n+        \n+        return profiles\n+            .Where(p => p.Name.StartsWith(query, StringComparison.OrdinalIgnoreCase))\n+            .Select(p => new AutoCompleteOption(\n+                p.Name,\n+                p.Name.Equals(defaultName, StringComparison.OrdinalIgnoreCase) \n+                    ? $\"{p.Name} (default)\" \n+                    : null))\n+            .ToList();\n+    }\n+}\n+```\n+\n+**Usage in Commands** (via attribute binding):\n+\n+```csharp\n+// In ProfileShowCommand, ProfileRemoveCommand, etc.\n+[Argument(Position = 0)]\n+[AutoComplete<ProfileNameProvider>]\n+[Description(\"Profile name\")]\n+public string Name { get; set; }\n+```\n+\n+**Key Implementation Notes**:\n+- `AutoCompleteContext` provides `QueryString`, `ArgumentInfo`, `CommandInfo`, `ProvidedValues`\n+- Handler is activated via `AutoCompleteHandlerActivator` with scoped DI\n+- Registration: `services.AddTransient<ProfileNameProvider>()` in `ConfigureSignalRClient()`\n+\n ### Platform Detection\n \n **Decision**: Use `RuntimeInformation.IsOSPlatform()` for platform-specific encryption selection.\ndiff --git a/specs/009-server-profile/spec.md b/specs/009-server-profile/spec.md\nindex 92bac18..ceb95be 100644\n--- a/specs/009-server-profile/spec.md\n+++ b/specs/009-server-profile/spec.md\n@@ -353,8 +353,8 @@ server profile set-key <name> [--apikey|-k <key>]\n #### Profile Storage\n - **FR-018**: System MUST store profile configuration in JSON format\n - **FR-019**: System MUST store profiles in platform-appropriate configuration directory:\n-  - Windows: `%APPDATA%\\BitPantry\\CommandLine\\profiles.json`\n-  - Linux/macOS: `~/.config/bitpantry-commandline/profiles.json` (respecting `XDG_CONFIG_HOME`)\n+  - Windows: `%APPDATA%\\BitPantry\\CommandLine\\profiles\\profiles.json`\n+  - Linux/macOS: `~/.bitpantry/commandline/profiles/profiles.json`\n - **FR-020**: System MUST create configuration directory if it doesn't exist\n - **FR-021**: System MUST handle corrupted configuration by creating backup and resetting\n - **FR-022**: System MUST treat profile names as case-insensitive\n@@ -399,13 +399,13 @@ Root storage object for profiles.json.\n #### Windows\n - **Mechanism**: Data Protection API (DPAPI)\n - **Scope**: CurrentUser (tied to logged-in Windows user)\n-- **Storage**: Encrypted credentials file at `%APPDATA%\\BitPantry\\CommandLine\\credentials.enc`\n+- **Storage**: Encrypted credentials file at `%APPDATA%\\BitPantry\\CommandLine\\profiles\\credentials.enc`\n \n #### Linux/macOS\n - **Mechanism**: libsodium SecretBox encryption\n - **Key Derivation**: 32-byte key from machine ID + username via GenericHash\n - **Machine ID**: `/etc/machine-id` on Linux, `Environment.MachineName` as fallback\n-- **Storage**: Encrypted credentials file at `~/.config/bitpantry-commandline/credentials.enc`\n+- **Storage**: Encrypted credentials file at `~/.bitpantry/commandline/profiles/credentials.enc`\n \n #### Credential File Format\n JSON dictionary mapping profile names (lowercase) to Base64-encoded encrypted API keys.\ndiff --git a/specs/009-server-profile/tasks.md b/specs/009-server-profile/tasks.md\nindex 6ac63c3..3afa8b0 100644\n--- a/specs/009-server-profile/tasks.md\n+++ b/specs/009-server-profile/tasks.md\n@@ -2,267 +2,271 @@\n \n **Branch**: `009-server-profile` | **Date**: 2026-02-02 | **Spec**: [spec.md](spec.md)\n \n-## Task Ordering Principles\n+## Task Format\n \n-1. **TDD**: Tests written before implementation\n-2. **Bottom-up**: Core services before commands\n-3. **Dependencies**: Each task builds on previous completed work\n-4. **Incremental**: Small, reviewable units of work\n+```text\n+- [ ] T### [depends:T###,T###] @test-case:009:XX-### Description with file path\n+```\n+\n+**Components**:\n+- **Checkbox**: `- [ ]` (marked `[X]` when completed)\n+- **Task ID**: Sequential (T001, T002, ...) globally unique\n+- **Dependencies**: `[depends:T001,T002]` ΓÇö tasks that must complete first (omit if none)\n+- **Test Case**: `@test-case:009:XX-###` ΓÇö exactly ONE test case ID from test-cases.md\n+- **Description**: Clear action with exact file path\n \n ---\n \n-## Phase 1: Foundation (Entities & Interfaces)\n+## Phase 1: Setup (Infrastructure)\n+\n+**Purpose**: Create foundational entities and interfaces ΓÇö no behavioral test cases\n \n-### T001 Γ£à Create ServerProfile entity\n-- [ ] Create `Profiles/ServerProfile.cs` with Name, Uri, ApiKey (JsonIgnore), CreatedAt, ModifiedAt\n-- [ ] Add XML documentation\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ServerProfile.cs`\n-- **Tests**: None (POCO)\n+- [ ] T001 @test-case:009:SETUP-001 Create ServerProfile entity in Profiles/ServerProfile.cs\n+- [ ] T002 [depends:T001] @test-case:009:SETUP-002 Create ProfileConfiguration storage model in Profiles/ProfileConfiguration.cs\n+- [ ] T003 [depends:T001] @test-case:009:SETUP-003 Create IProfileManager interface in Profiles/IProfileManager.cs\n+- [ ] T004 [depends:T001] @test-case:009:SETUP-004 Create ICredentialStore interface (internal) in Profiles/ICredentialStore.cs\n+- [ ] T005 [depends:T001] @test-case:009:SETUP-005 Add Sodium.Core package reference to csproj\n \n-### T002 Γ£à Create ProfileConfiguration storage model  \n-- [ ] Create `Profiles/ProfileConfiguration.cs` with DefaultProfile, Profiles dictionary, Version\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileConfiguration.cs`\n-- **Tests**: None (POCO)\n+---\n \n-### T003 Γ£à Create IProfileManager interface\n-- [ ] Create `Profiles/IProfileManager.cs` with all methods from data-model.md\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/IProfileManager.cs`\n-- **Tests**: None (interface)\n+## Phase 2: CredentialStore (TDD)\n \n-### T004 Γ£à Create ICredentialStore interface (internal)\n-- [ ] Create `Profiles/ICredentialStore.cs` as internal interface\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ICredentialStore.cs`\n-- **Tests**: None (interface)\n+**Goal**: Implement secure credential storage with DPAPI (Windows) and libsodium (Linux/macOS)\n \n----\n+### Windows DPAPI Tests\n+\n+- [ ] T010 [depends:T004] @test-case:009:CS-001 Test Store_ValidApiKey_EncryptsWithDPAPI in CredentialStoreTests.cs\n+- [ ] T011 [depends:T004] @test-case:009:CS-002 Test Retrieve_StoredKey_DecryptsCorrectly in CredentialStoreTests.cs\n+- [ ] T012 [depends:T004] @test-case:009:CS-003 Test Retrieve_NonExistent_ReturnsNull in CredentialStoreTests.cs\n+- [ ] T013 [depends:T004] @test-case:009:CS-004 Test Remove_ExistingCredential_RemovesEntry in CredentialStoreTests.cs\n+- [ ] T014 [depends:T004] @test-case:009:CS-005 Test Exists_StoredCredential_ReturnsTrue in CredentialStoreTests.cs\n+- [ ] T015 [depends:T004] @test-case:009:CS-006 Test Exists_NonExistent_ReturnsFalse in CredentialStoreTests.cs\n+\n+### libsodium Tests\n+\n+- [ ] T016 [depends:T004,T005] @test-case:009:CS-010 Test Store_ValidApiKey_EncryptsWithSecretBox in CredentialStoreTests.cs\n+- [ ] T017 [depends:T004,T005] @test-case:009:CS-011 Test Retrieve_StoredKey_DecryptsCorrectly (libsodium) in CredentialStoreTests.cs\n+- [ ] T018 [depends:T004,T005] @test-case:009:CS-012 Test Store_LibsodiumUnavailable_ThrowsWithMessage in CredentialStoreTests.cs\n \n-## Phase 2: Credential Store (TDD)\n-\n-### T010 ≡ƒº¬ Write CredentialStore unit tests\n-- [ ] Create `ProfileTests/CredentialStoreTests.cs`\n-- [ ] Implement tests: CS-001 through CS-006 (Windows DPAPI)\n-- [ ] Implement tests: CS-010 through CS-012 (libsodium - conditional)\n-- [ ] Implement tests: CS-020 through CS-022 (cross-platform)\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/CredentialStoreTests.cs`\n-- **Depends**: T004\n-\n-### T011 Γ£à Implement CredentialStore\n-- [ ] Create `Profiles/CredentialStore.cs`\n-- [ ] Implement platform detection (RuntimeInformation.IsOSPlatform)\n-- [ ] Implement DPAPI encryption for Windows\n-- [ ] Implement libsodium encryption for Linux/macOS\n-- [ ] Implement machine ID retrieval for key derivation\n-- [ ] Handle DllNotFoundException with actionable error (FR-017a)\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/CredentialStore.cs`\n-- **Depends**: T010 (tests first)\n-- **Verify**: All T010 tests pass\n+### Cross-Platform Tests\n+\n+- [ ] T019 [depends:T004] @test-case:009:CS-020 Test Store_EmptyApiKey_ThrowsValidation in CredentialStoreTests.cs\n+- [ ] T020 [depends:T004] @test-case:009:CS-021 Test Store_MultipleProfiles_IndependentStorage in CredentialStoreTests.cs\n+- [ ] T021 [depends:T004] @test-case:009:CS-022 Test Remove_AlsoRemovesFromProfile_OnDelete in CredentialStoreTests.cs\n+\n+### CredentialStore Implementation\n+\n+- [ ] T022 [depends:T010,T011,T012,T013,T014,T015,T016,T017,T018,T019,T020,T021] @test-case:009:IMPL-CS Implement CredentialStore in Profiles/CredentialStore.cs\n \n ---\n \n-## Phase 3: Profile Manager (TDD)\n-\n-### T020 ≡ƒº¬ Write ProfileManager unit tests - CRUD\n-- [ ] Create `ProfileTests/ProfileManagerTests.cs`\n-- [ ] Implement tests: PM-001 through PM-011 (basic CRUD)\n-- [ ] Use MockFileSystem for file operations\n-- [ ] Mock ICredentialStore for credential operations\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ProfileManagerTests.cs`\n-- **Depends**: T003, T004\n-\n-### T021 ≡ƒº¬ Write ProfileManager unit tests - Default & Validation\n-- [ ] Add tests: PM-020 through PM-024 (default profile)\n-- [ ] Add tests: PM-030 through PM-035 (validation)\n-- [ ] Add tests: PM-040 through PM-042 (edge cases)\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ProfileManagerTests.cs`\n-- **Depends**: T020\n-\n-### T022 Γ£à Implement ProfileManager\n-- [ ] Create `Profiles/ProfileManager.cs`\n-- [ ] Inject IFileSystem, ICredentialStore\n-- [ ] Implement JSON serialization with System.Text.Json\n-- [ ] Implement path resolution (~/.bitpantry/commandline/profiles/)\n-- [ ] Implement atomic writes (temp file + rename)\n-- [ ] Implement profile name validation\n-- [ ] Implement credential integration (populate ApiKey on GetProfileAsync)\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Profiles/ProfileManager.cs`\n-- **Depends**: T020, T021 (tests first), T011\n-- **Verify**: All T020, T021 tests pass\n+## Phase 3: ProfileManager (TDD)\n+\n+**Goal**: Implement profile CRUD, validation, and default profile management\n+\n+### Basic CRUD Tests\n+\n+- [ ] T030 [depends:T003] @test-case:009:PM-001 Test GetAllProfiles_EmptyStore_ReturnsEmptyList in ProfileManagerTests.cs\n+- [ ] T031 [depends:T003] @test-case:009:PM-002 Test GetAllProfiles_MultipleProfiles_ReturnsAll in ProfileManagerTests.cs\n+- [ ] T032 [depends:T003] @test-case:009:PM-003 Test GetProfile_ExistingProfile_ReturnsProfile in ProfileManagerTests.cs\n+- [ ] T033 [depends:T003] @test-case:009:PM-004 Test GetProfile_NonExistentProfile_ReturnsNull in ProfileManagerTests.cs\n+- [ ] T034 [depends:T003] @test-case:009:PM-005 Test GetProfile_CaseInsensitive_ReturnsProfile in ProfileManagerTests.cs\n+- [ ] T035 [depends:T003] @test-case:009:PM-006 Test SaveProfile_NewProfile_PersistsToStorage in ProfileManagerTests.cs\n+- [ ] T036 [depends:T003] @test-case:009:PM-007 Test SaveProfile_ExistingProfile_UpdatesProfile in ProfileManagerTests.cs\n+- [ ] T037 [depends:T003] @test-case:009:PM-008 Test SaveProfile_SetsCreatedAt_OnNewProfile in ProfileManagerTests.cs\n+- [ ] T038 [depends:T003] @test-case:009:PM-009 Test DeleteProfile_ExistingProfile_ReturnsTrue in ProfileManagerTests.cs\n+- [ ] T039 [depends:T003] @test-case:009:PM-010 Test DeleteProfile_NonExistent_ReturnsFalse in ProfileManagerTests.cs\n+- [ ] T040 [depends:T003] @test-case:009:PM-011 Test DeleteProfile_RemovesFromStorage in ProfileManagerTests.cs\n+\n+### Default Profile Tests\n+\n+- [ ] T041 [depends:T003] @test-case:009:PM-020 Test GetDefaultProfileName_NoneSet_ReturnsNull in ProfileManagerTests.cs\n+- [ ] T042 [depends:T003] @test-case:009:PM-021 Test GetDefaultProfileName_WhenSet_ReturnsName in ProfileManagerTests.cs\n+- [ ] T043 [depends:T003] @test-case:009:PM-022 Test SetDefaultProfile_ValidName_PersistsDefault in ProfileManagerTests.cs\n+- [ ] T044 [depends:T003] @test-case:009:PM-023 Test SetDefaultProfile_Null_ClearsDefault in ProfileManagerTests.cs\n+- [ ] T045 [depends:T003] @test-case:009:PM-024 Test DeleteProfile_WasDefault_ClearsDefault in ProfileManagerTests.cs\n+\n+### Validation Tests\n+\n+- [ ] T046 [depends:T003] @test-case:009:PM-030 Test SaveProfile_EmptyName_ThrowsValidation in ProfileManagerTests.cs\n+- [ ] T047 [depends:T003] @test-case:009:PM-031 Test SaveProfile_InvalidCharacters_ThrowsValidation in ProfileManagerTests.cs\n+- [ ] T048 [depends:T003] @test-case:009:PM-032 Test SaveProfile_TooLongName_ThrowsValidation in ProfileManagerTests.cs\n+- [ ] T049 [depends:T003] @test-case:009:PM-033 Test SaveProfile_HyphenInName_Succeeds in ProfileManagerTests.cs\n+- [ ] T050 [depends:T003] @test-case:009:PM-034 Test SaveProfile_StartsWithHyphen_ThrowsValidation in ProfileManagerTests.cs\n+- [ ] T051 [depends:T003] @test-case:009:PM-035 Test SaveProfile_InvalidUri_ThrowsValidation in ProfileManagerTests.cs\n+\n+### Edge Case Tests\n+\n+- [ ] T052 [depends:T003] @test-case:009:PM-040 Test SaveProfile_CorruptedFile_RecreatesFile in ProfileManagerTests.cs\n+- [ ] T053 [depends:T003] @test-case:009:PM-041 Test GetAllProfiles_MissingFile_ReturnsEmpty in ProfileManagerTests.cs\n+- [ ] T054 [depends:T003] @test-case:009:PM-042 Test SaveProfile_DirectoryNotExists_CreatesDirectory in ProfileManagerTests.cs\n+\n+### ProfileManager Implementation\n+\n+- [ ] T055 [depends:T022,T030,T031,T032,T033,T034,T035,T036,T037,T038,T039,T040,T041,T042,T043,T044,T045,T046,T047,T048,T049,T050,T051,T052,T053,T054] @test-case:009:IMPL-PM Implement ProfileManager in Profiles/ProfileManager.cs\n \n ---\n \n ## Phase 4: Autocomplete Handler (TDD)\n \n-### T030 ≡ƒº¬ Write ProfileNameProvider tests\n-- [ ] Create autocomplete tests section in ProfileManagerTests or separate file\n-- [ ] Implement tests: AC-001 through AC-005\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ProfileNameProviderTests.cs`\n-- **Depends**: T022\n-\n-### T031 Γ£à Implement ProfileNameProvider\n-- [ ] Create `AutoComplete/ProfileNameProvider.cs`\n-- [ ] Implement IAutoCompleteHandler\n-- [ ] Inject IProfileManager\n-- [ ] Filter by prefix, mark default with indicator\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/AutoComplete/ProfileNameProvider.cs`\n-- **Depends**: T030 (tests first)\n-- **Verify**: All T030 tests pass\n+**Goal**: Implement profile name autocomplete with default indicator\n+\n+- [ ] T060 [depends:T055] @test-case:009:AC-001 Test GetOptions_NoProfiles_ReturnsEmpty in ProfileNameProviderTests.cs\n+- [ ] T061 [depends:T055] @test-case:009:AC-002 Test GetOptions_MultipleProfiles_ReturnsAll in ProfileNameProviderTests.cs\n+- [ ] T062 [depends:T055] @test-case:009:AC-003 Test GetOptions_WithPrefix_FiltersResults in ProfileNameProviderTests.cs\n+- [ ] T063 [depends:T055] @test-case:009:AC-004 Test GetOptions_CaseInsensitivePrefix_Matches in ProfileNameProviderTests.cs\n+- [ ] T064 [depends:T055] @test-case:009:AC-005 Test GetOptions_IncludesDefault_MarksIndicator in ProfileNameProviderTests.cs\n+- [ ] T065 [depends:T055] @test-case:009:AC-006 Test GetOptions_Performance_Under100ms in ProfileNameProviderTests.cs\n+\n+### ProfileNameProvider Implementation\n+\n+- [ ] T066 [depends:T060,T061,T062,T063,T064,T065] @test-case:009:IMPL-AC Implement ProfileNameProvider in AutoComplete/ProfileNameProvider.cs\n \n ---\n \n ## Phase 5: Profile Commands (TDD)\n \n-### T040 Γ£à Create ProfileGroup\n-- [ ] Create `Commands/Server/Profile/ProfileGroup.cs`\n-- [ ] Use [Group(Name = \"profile\")] attribute\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileGroup.cs`\n-- **Tests**: None (attribute-only)\n-\n-### T041 ≡ƒº¬ Write ProfileAddCommand tests\n-- [ ] Create `ProfileTests/ProfileCommandTests.cs`\n-- [ ] Implement tests: CMD-ADD-001 through CMD-ADD-006\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ProfileCommandTests.cs`\n-- **Depends**: T022, T040\n-\n-### T042 Γ£à Implement ProfileAddCommand\n-- [ ] Create `Commands/Server/Profile/ProfileAddCommand.cs`\n-- [ ] Arguments: name (positional), --uri/-u, --api-key/-k, --default\n-- [ ] Inject IProfileManager\n-- [ ] Handle masked input for API key\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileAddCommand.cs`\n-- **Depends**: T041 (tests first)\n-- **Verify**: CMD-ADD tests pass\n-\n-### T043 ≡ƒº¬ Write ProfileListCommand tests\n-- [ ] Add tests: CMD-LST-001 through CMD-LST-004\n-- **Depends**: T041\n-\n-### T044 Γ£à Implement ProfileListCommand\n-- [ ] Create `Commands/Server/Profile/ProfileListCommand.cs`\n-- [ ] Display table with Name, URI, Default, Has Credential columns\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileListCommand.cs`\n-- **Depends**: T043 (tests first)\n-- **Verify**: CMD-LST tests pass\n-\n-### T045 ≡ƒº¬ Write ProfileShowCommand tests\n-- [ ] Add tests: CMD-SHW-001 through CMD-SHW-004\n-- **Depends**: T041\n-\n-### T046 Γ£à Implement ProfileShowCommand\n-- [ ] Create `Commands/Server/Profile/ProfileShowCommand.cs`\n-- [ ] Argument: name (positional) with ProfileNameProvider autocomplete\n-- [ ] Display profile details, mask API key\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileShowCommand.cs`\n-- **Depends**: T045 (tests first), T031\n-- **Verify**: CMD-SHW tests pass\n-\n-### T047 ≡ƒº¬ Write ProfileRemoveCommand tests\n-- [ ] Add tests: CMD-RMV-001 through CMD-RMV-004\n-- **Depends**: T041\n-\n-### T048 Γ£à Implement ProfileRemoveCommand\n-- [ ] Create `Commands/Server/Profile/ProfileRemoveCommand.cs`\n-- [ ] Argument: name (positional) with autocomplete\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileRemoveCommand.cs`\n-- **Depends**: T047 (tests first)\n-- **Verify**: CMD-RMV tests pass\n-\n-### T049 ≡ƒº¬ Write ProfileSetDefaultCommand tests\n-- [ ] Add tests: CMD-DEF-001 through CMD-DEF-003\n-- **Depends**: T041\n-\n-### T050 Γ£à Implement ProfileSetDefaultCommand\n-- [ ] Create `Commands/Server/Profile/ProfileSetDefaultCommand.cs`\n-- [ ] Argument: name (positional) with autocomplete, --none flag\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileSetDefaultCommand.cs`\n-- **Depends**: T049 (tests first)\n-- **Verify**: CMD-DEF tests pass\n-\n-### T051 ≡ƒº¬ Write ProfileSetKeyCommand tests\n-- [ ] Add tests: CMD-KEY-001 through CMD-KEY-004\n-- **Depends**: T041\n-\n-### T052 Γ£à Implement ProfileSetKeyCommand\n-- [ ] Create `Commands/Server/Profile/ProfileSetKeyCommand.cs`\n-- [ ] Arguments: name (positional), --api-key/-k (prompts if not provided)\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/Profile/ProfileSetKeyCommand.cs`\n-- **Depends**: T051 (tests first)\n-- **Verify**: CMD-KEY tests pass\n+**Goal**: Implement profile management commands\n+\n+### ProfileGroup Setup\n+\n+- [ ] T070 [depends:T055] @test-case:009:SETUP-006 Create ProfileGroup in Commands/Server/Profile/ProfileGroup.cs\n+\n+### profile add Command\n+\n+- [ ] T071 [depends:T070] @test-case:009:CMD-ADD-001 Test Add_ValidProfile_CreatesProfile in ProfileCommandTests.cs\n+- [ ] T072 [depends:T070] @test-case:009:CMD-ADD-002 Test Add_DuplicateName_ShowsError in ProfileCommandTests.cs\n+- [ ] T073 [depends:T070] @test-case:009:CMD-ADD-003 Test Add_WithApiKey_StoresCredential in ProfileCommandTests.cs\n+- [ ] T074 [depends:T070] @test-case:009:CMD-ADD-004 Test Add_WithApiKeyPrompt_MasksInput in ProfileCommandTests.cs\n+- [ ] T075 [depends:T070] @test-case:009:CMD-ADD-005 Test Add_InvalidUri_ShowsError in ProfileCommandTests.cs\n+- [ ] T076 [depends:T070] @test-case:009:CMD-ADD-006 Test Add_SetAsDefault_SetsDefault in ProfileCommandTests.cs\n+- [ ] T077 [depends:T071,T072,T073,T074,T075,T076] @test-case:009:IMPL-ADD Implement ProfileAddCommand in Commands/Server/Profile/ProfileAddCommand.cs\n+\n+### profile list Command\n+\n+- [ ] T078 [depends:T070] @test-case:009:CMD-LST-001 Test List_NoProfiles_ShowsEmptyMessage in ProfileCommandTests.cs\n+- [ ] T079 [depends:T070] @test-case:009:CMD-LST-002 Test List_MultipleProfiles_ShowsTable in ProfileCommandTests.cs\n+- [ ] T080 [depends:T070] @test-case:009:CMD-LST-003 Test List_MarksDefault_WithIndicator in ProfileCommandTests.cs\n+- [ ] T081 [depends:T070] @test-case:009:CMD-LST-004 Test List_IncludesCredentials_Column in ProfileCommandTests.cs\n+- [ ] T082 [depends:T078,T079,T080,T081] @test-case:009:IMPL-LST Implement ProfileListCommand in Commands/Server/Profile/ProfileListCommand.cs\n+\n+### profile show Command\n+\n+- [ ] T083 [depends:T066,T070] @test-case:009:CMD-SHW-001 Test Show_ExistingProfile_DisplaysDetails in ProfileCommandTests.cs\n+- [ ] T084 [depends:T070] @test-case:009:CMD-SHW-002 Test Show_NonExistent_ShowsError in ProfileCommandTests.cs\n+- [ ] T085 [depends:T070] @test-case:009:CMD-SHW-003 Test Show_WithCredential_ShowsMasked in ProfileCommandTests.cs\n+- [ ] T086 [depends:T066,T070] @test-case:009:CMD-SHW-004 Test Show_ProfileNameAutocomplete_Works in ProfileCommandTests.cs\n+- [ ] T087 [depends:T083,T084,T085,T086] @test-case:009:IMPL-SHW Implement ProfileShowCommand in Commands/Server/Profile/ProfileShowCommand.cs\n+\n+### profile remove Command\n+\n+- [ ] T088 [depends:T066,T070] @test-case:009:CMD-RMV-001 Test Remove_ExistingProfile_DeletesProfile in ProfileCommandTests.cs\n+- [ ] T089 [depends:T070] @test-case:009:CMD-RMV-002 Test Remove_NonExistent_ShowsError in ProfileCommandTests.cs\n+- [ ] T090 [depends:T070] @test-case:009:CMD-RMV-003 Test Remove_AlsoRemoves_Credential in ProfileCommandTests.cs\n+- [ ] T091 [depends:T070] @test-case:009:CMD-RMV-004 Test Remove_WasDefault_ClearsDefault in ProfileCommandTests.cs\n+- [ ] T092 [depends:T088,T089,T090,T091] @test-case:009:IMPL-RMV Implement ProfileRemoveCommand in Commands/Server/Profile/ProfileRemoveCommand.cs\n+\n+### profile set-default Command\n+\n+- [ ] T093 [depends:T066,T070] @test-case:009:CMD-DEF-001 Test SetDefault_ExistingProfile_SetsDefault in ProfileCommandTests.cs\n+- [ ] T094 [depends:T070] @test-case:009:CMD-DEF-002 Test SetDefault_NonExistent_ShowsError in ProfileCommandTests.cs\n+- [ ] T095 [depends:T070] @test-case:009:CMD-DEF-003 Test SetDefault_ClearWithNone_ClearsDefault in ProfileCommandTests.cs\n+- [ ] T096 [depends:T093,T094,T095] @test-case:009:IMPL-DEF Implement ProfileSetDefaultCommand in Commands/Server/Profile/ProfileSetDefaultCommand.cs\n+\n+### profile set-key Command\n+\n+- [ ] T097 [depends:T066,T070] @test-case:009:CMD-KEY-001 Test SetKey_ExistingProfile_UpdatesCredential in ProfileCommandTests.cs\n+- [ ] T098 [depends:T070] @test-case:009:CMD-KEY-002 Test SetKey_NonExistent_ShowsError in ProfileCommandTests.cs\n+- [ ] T099 [depends:T070] @test-case:009:CMD-KEY-003 Test SetKey_PromptsWithMasking_WhenNoValue in ProfileCommandTests.cs\n+- [ ] T100 [depends:T070] @test-case:009:CMD-KEY-004 Test SetKey_EmptyInput_ShowsError in ProfileCommandTests.cs\n+- [ ] T101 [depends:T097,T098,T099,T100] @test-case:009:IMPL-KEY Implement ProfileSetKeyCommand in Commands/Server/Profile/ProfileSetKeyCommand.cs\n \n ---\n \n ## Phase 6: ConnectCommand Integration (TDD)\n \n-### T060 ≡ƒº¬ Write ConnectCommand --profile tests\n-- [ ] Add tests: CMD-CON-001 through CMD-CON-006\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ConnectProfileTests.cs`\n-- **Depends**: T022\n-\n-### T061 Γ£à Modify ConnectCommand for --profile support\n-- [ ] Add --profile/-p argument with ProfileNameProvider autocomplete\n-- [ ] Inject IProfileManager\n-- [ ] Resolve profile ΓåÆ use profile.Uri and profile.ApiKey\n-- [ ] Handle --profile + --uri override (--uri wins)\n-- [ ] Handle missing credential ΓåÆ prompt for API key\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/ConnectCommand.cs` (MODIFY)\n-- **Depends**: T060 (tests first)\n-- **Verify**: CMD-CON tests pass\n+**Goal**: Add --profile support to existing ConnectCommand\n+\n+- [ ] T110 [depends:T055,T066] @test-case:009:CMD-CON-001 Test Connect_WithProfile_UsesProfileSettings in ConnectProfileTests.cs\n+- [ ] T111 [depends:T055] @test-case:009:CMD-CON-002 Test Connect_ProfileNoCredential_PromptsForKey in ConnectProfileTests.cs\n+- [ ] T112 [depends:T055] @test-case:009:CMD-CON-003 Test Connect_ProfileAndUri_UriOverrides in ConnectProfileTests.cs\n+- [ ] T113 [depends:T055] @test-case:009:CMD-CON-004 Test Connect_ProfileNotFound_ShowsError in ConnectProfileTests.cs\n+- [ ] T114 [depends:T055] @test-case:009:CMD-CON-005 Test Connect_NoProfileNoUri_UsesDefault in ConnectProfileTests.cs\n+- [ ] T115 [depends:T066] @test-case:009:CMD-CON-006 Test Connect_ProfileAutocomplete_Works in ConnectProfileTests.cs\n+- [ ] T116 [depends:T110,T111,T112,T113,T114,T115] @test-case:009:IMPL-CON Modify ConnectCommand for --profile support in Commands/Server/ConnectCommand.cs\n+\n+---\n+\n+## Phase 7: DI Registration\n+\n+**Goal**: Wire up all services in the DI container\n+\n+- [ ] T120 [depends:T022,T055,T066,T077,T082,T087,T092,T096,T101,T116] @test-case:009:SETUP-007 Register profile services in CommandLineApplicationBuilderExtensions.cs\n \n ---\n \n-## Phase 7: DI Registration & Bootstrap\n+## Phase 8: Prompt Segment (TDD)\n \n-### T070 Γ£à Register profile services in ConfigureSignalRClient\n-- [ ] Add ICredentialStore ΓåÆ CredentialStore (Singleton)\n-- [ ] Add IProfileManager ΓåÆ ProfileManager (Singleton)\n-- [ ] Add ProfileNameProvider (Transient)\n-- [ ] Register all profile commands\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/CommandLineApplicationBuilderExtensions.cs` (MODIFY)\n-- **Depends**: T022, T031, T042-T052\n+**Goal**: Display connected profile name in command prompt (US-7, FR-026-028)\n \n-### T071 Γ£à Add Sodium.Core package reference\n-- [ ] Add `<PackageReference Include=\"Sodium.Core\" Version=\"1.3.7\" />` to csproj\n-- **File**: `BitPantry.CommandLine.Remote.SignalR.Client/BitPantry.CommandLine.Remote.SignalR.Client.csproj` (MODIFY)\n-- **Depends**: T011\n+- [ ] T150 [depends:T120] @test-case:009:PS-001 Test ConnectedViaProfile_PromptShowsProfileName in PromptSegmentTests.cs\n+- [ ] T151 [depends:T150] @test-case:009:PS-002 Test ConnectedViaProfile_PromptShowsBracketFormat in PromptSegmentTests.cs\n+- [ ] T152 [depends:T150] @test-case:009:PS-003 Test NotConnected_PromptHidesProfileSegment in PromptSegmentTests.cs\n+- [ ] T153 [depends:T150] @test-case:009:PS-004 Test ConnectedDirectUri_PromptHidesProfileSegment in PromptSegmentTests.cs\n+- [ ] T154 [depends:T150,T151,T152,T153] @test-case:009:IMPL-PS Implement ProfilePromptSegment in Prompt/ProfilePromptSegment.cs\n \n ---\n \n-## Phase 8: Integration Tests\n+## Phase 9: Integration Tests\n+\n+**Goal**: Verify end-to-end workflows across platforms\n+\n+### End-to-End Workflows\n+\n+- [ ] T130 [depends:T120] @test-case:009:INT-001 Test FullWorkflow_AddListShowRemove in ProfileIntegrationTests.cs\n+- [ ] T131 [depends:T120] @test-case:009:INT-002 Test FullWorkflow_AddSetDefaultConnect in ProfileIntegrationTests.cs\n+- [ ] T132 [depends:T120] @test-case:009:INT-003 Test FullWorkflow_UpdateCredential in ProfileIntegrationTests.cs\n+- [ ] T133 [depends:T120] @test-case:009:INT-004 Test FullWorkflow_MultipleProfiles in ProfileIntegrationTests.cs\n+\n+### Cross-Platform\n+\n+- [ ] T134 [depends:T120] @test-case:009:XP-001 Test Encryption_Windows_UseDPAPI in ProfileIntegrationTests.cs\n+- [ ] T135 [depends:T120] @test-case:009:XP-002 Test Encryption_Linux_UseLibsodium in ProfileIntegrationTests.cs\n+- [ ] T136 [depends:T120] @test-case:009:XP-003 Test Encryption_MacOS_UseLibsodium in ProfileIntegrationTests.cs\n+- [ ] T137 [depends:T120] @test-case:009:XP-004 Test Credential_DifferentMachine_FailsDecrypt in ProfileIntegrationTests.cs\n+\n+### Error Handling\n \n-### T080 ≡ƒº¬ Write end-to-end integration tests\n-- [ ] Create `ProfileTests/ProfileIntegrationTests.cs`\n-- [ ] Implement tests: INT-001 through INT-004 (workflows)\n-- [ ] Implement tests: XP-001 through XP-004 (cross-platform)\n-- [ ] Implement tests: ERR-001 through ERR-003 (error handling)\n-- **File**: `BitPantry.CommandLine.Tests.Remote.SignalR/ProfileTests/ProfileIntegrationTests.cs`\n-- **Depends**: T070\n+- [ ] T138 [depends:T120] @test-case:009:ERR-001 Test StorageInaccessible_ShowsErrorMessage in ProfileIntegrationTests.cs\n+- [ ] T139 [depends:T120] @test-case:009:ERR-002 Test CorruptedCredentials_ShowsReenterMessage in ProfileIntegrationTests.cs\n+- [ ] T140 [depends:T120] @test-case:009:ERR-003 Test LibsodiumMissing_ShowsInstallInstructions in ProfileIntegrationTests.cs\n \n ---\n \n ## Task Summary\n \n-| Phase | Tasks | Description |\n-|-------|-------|-------------|\n-| 1 | T001-T004 | Foundation (entities, interfaces) |\n-| 2 | T010-T011 | CredentialStore (TDD) |\n-| 3 | T020-T022 | ProfileManager (TDD) |\n-| 4 | T030-T031 | Autocomplete (TDD) |\n-| 5 | T040-T052 | Profile commands (TDD) |\n-| 6 | T060-T061 | ConnectCommand integration (TDD) |\n-| 7 | T070-T071 | DI & packages |\n-| 8 | T080 | Integration tests |\n-\n-**Total**: 26 tasks  \n-**Test-first tasks**: 12 (≡ƒº¬)  \n-**Implementation tasks**: 14 (Γ£à)\n+| Phase | Task Range | Count | Description |\n+|-------|------------|-------|-------------|\n+| 1: Setup | T001-T005 | 5 | Entities, interfaces, package refs |\n+| 2: CredentialStore | T010-T022 | 13 | Encryption tests + implementation |\n+| 3: ProfileManager | T030-T055 | 26 | CRUD, validation, edge case tests + implementation |\n+| 4: Autocomplete | T060-T066 | 7 | ProfileNameProvider tests + implementation |\n+| 5: Commands | T070-T101 | 32 | All profile commands |\n+| 6: Connect Integration | T110-T116 | 7 | ConnectCommand --profile support |\n+| 7: DI Registration | T120 | 1 | Service wiring |\n+| 8: Prompt Segment | T150-T154 | 5 | Prompt display for connected profile |\n+| 9: Integration Tests | T130-T140 | 11 | E2E and cross-platform tests |\n+\n+**Total Tasks**: 107  \n+**Test Case Tasks**: 80  \n+**Setup/Implementation Tasks**: 27\n \n ---\n \n-## Completion Checklist\n+## Test Case Validation\n \n-- [ ] All unit tests pass (`dotnet test`)\n-- [ ] All integration tests pass\n-- [ ] Code coverage meets targets (ProfileManager 95%, CredentialStore 90%, Commands 85%)\n-- [ ] No compiler warnings\n-- [ ] XML documentation complete\n-- [ ] Manual smoke test on Windows\n-- [ ] Manual smoke test on Linux/macOS (if available)\n+- [X] Every test case from test-cases.md has exactly ONE task\n+- [X] Every task (except SETUP/IMPL) has exactly ONE `@test-case:` reference\n+- [X] Dependencies form a valid DAG (no circular dependencies)\n+- [X] Task IDs are sequential and unique\n+- [X] Each task has a clear file path in description\ndiff --git a/specs/009-server-profile/test-cases.md b/specs/009-server-profile/test-cases.md\nindex 7a81236..2c8f64e 100644\n--- a/specs/009-server-profile/test-cases.md\n+++ b/specs/009-server-profile/test-cases.md\n@@ -191,6 +191,15 @@\n | ERR-002 | CorruptedCredentials_ShowsReenterMessage | Corrupted credentials prompt re-entry | P1 |\n | ERR-003 | LibsodiumMissing_ShowsInstallInstructions | Missing library shows install steps | P0 |\n \n+### Prompt Segment Display\n+\n+| ID | Test Name | Description | Priority |\n+|----|-----------|-------------|----------|\n+| PS-001 | ConnectedViaProfile_PromptShowsProfileName | Prompt includes profile name when connected via profile (FR-026) | P2 |\n+| PS-002 | ConnectedViaProfile_PromptShowsBracketFormat | Prompt shows format `[profile-name]` (FR-027) | P2 |\n+| PS-003 | NotConnected_PromptHidesProfileSegment | No profile segment when not connected (FR-028) | P2 |\n+| PS-004 | ConnectedDirectUri_PromptHidesProfileSegment | No profile segment when connected via direct URI (FR-028) | P2 |\n+\n ## Test Data\n \n ### Valid Profiles"
  }
}
