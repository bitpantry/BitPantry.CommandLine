{
  "taskId": "T130",
  "testCase": "",
  "red": {
    "timestamp": "2026-01-14T09:41:10.9277673-06:00",
    "testCommand": "dotnet test --filter ConnectionLostVia",
    "exitCode": 1,
    "output": "Expected Connection lost during download but got Download failed:",
    "testFile": "BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs",
    "testMethod": "Execute_ConnectionLostViaInvalidOperation_DisplaysConnectionLostError"
  },
  "green": {
    "timestamp": "2026-01-14T09:41:55.3123011-06:00",
    "testCommand": "dotnet test --filter ConnectionLostVia",
    "exitCode": 0,
    "output": "Passed: 430, Failed: 0"
  },
  "diff": {
    "timestamp": "2026-01-14T09:41:55.3123011-06:00",
    "files": [
      "BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs",
      "BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs",
      "BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs",
      "specs/007-download-command/batch-state.json",
      "specs/007-download-command/batches/batch-004.md"
    ],
    "patch": "diff --git a/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs b/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\nindex 92d5d6f..7dc920a 100644\n--- a/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\n+++ b/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\n@@ -1,5 +1,6 @@\n using BitPantry.CommandLine.API;\n using BitPantry.CommandLine.Client;\n+using BitPantry.CommandLine.Remote.SignalR;\n using BitPantry.CommandLine.Remote.SignalR.Envelopes;\n using Spectre.Console;\n using System.Collections.Concurrent;\n@@ -129,6 +130,18 @@ namespace BitPantry.CommandLine.Remote.SignalR.Client.Commands.Server\n             {\n                 _console.MarkupLine($\"[red]File not found:[/] {Markup.Escape(ex.Message)}\");\n             }\n+            catch (UnauthorizedAccessException ex)\n+            {\n+                _console.MarkupLine($\"[red]Permission denied:[/] {Markup.Escape(ex.Message)}\");\n+            }\n+            catch (InvalidOperationException ex) when (ex.Message.Contains(\"disconnected\"))\n+            {\n+                _console.MarkupLine(\"[red]Connection lost during download[/]\");\n+            }\n+            catch (RemoteMessagingException)\n+            {\n+                _console.MarkupLine(\"[red]Connection lost during download[/]\");\n+            }\n             catch (Exception ex)\n             {\n                 _console.MarkupLine($\"[red]Download failed:[/] {Markup.Escape(ex.Message)}\");\ndiff --git a/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs b/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\nindex a30b4d7..961b02a 100644\n--- a/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\n+++ b/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\n@@ -195,7 +195,7 @@ namespace BitPantry.CommandLine.Remote.SignalR.Client\n         /// <exception cref=\"InvalidOperationException\">Thrown if the client is disconnected</exception>\n         /// <exception cref=\"FileNotFoundException\">Thrown if the remote file does not exist</exception>\n         /// <exception cref=\"InvalidDataException\">Thrown if the checksum verification fails</exception>\n-        public async Task DownloadFile(string remoteFilePath, string localFilePath, Func<FileDownloadProgress, Task> progressCallback, CancellationToken token = default)\n+        public virtual async Task DownloadFile(string remoteFilePath, string localFilePath, Func<FileDownloadProgress, Task> progressCallback, CancellationToken token = default)\n         {\n             if (_proxy.ConnectionState != ServerProxyConnectionState.Connected)\n                 throw new InvalidOperationException(\"The client is disconnected\");\ndiff --git a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\nindex 1851c78..baaf654 100644\n--- a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\n+++ b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\n@@ -2,6 +2,7 @@ using BitPantry.CommandLine.API;\n using BitPantry.CommandLine.Client;\n using BitPantry.CommandLine.Component;\n using BitPantry.CommandLine.Processing.Execution;\n+using BitPantry.CommandLine.Remote.SignalR;\n using BitPantry.CommandLine.Remote.SignalR.Client;\n using BitPantry.CommandLine.Remote.SignalR.Client.Commands.Server;\n using BitPantry.CommandLine.Remote.SignalR.Envelopes;\n@@ -747,6 +748,127 @@ namespace BitPantry.CommandLine.Tests.Remote.SignalR.ClientTests\n \n         #endregion\n \n+        #region Error Handling Tests (UX-019, EH-005, T129)\n+\n+        /// <summary>\n+        /// Implements: UX-019, EH-005, T129 (IMPL-129)\n+        /// When: UnauthorizedAccessException thrown during local file write\n+        /// Then: Display \"Permission denied: [details]\" error message\n+        /// </summary>\n+        [TestMethod]\n+        public async Task Execute_PermissionDenied_DisplaysPermissionDeniedError()\n+        {\n+            // Arrange\n+            _proxyMock.Setup(p => p.ConnectionState).Returns(ServerProxyConnectionState.Connected);\n+            \n+            var mockService = new Mock<FileTransferService>(\n+                new Mock<ILogger<FileTransferService>>().Object,\n+                _proxyMock.Object,\n+                new Mock<IHttpClientFactory>().Object,\n+                TestAccessTokenManager.Create(new HttpResponseMessage(HttpStatusCode.Unauthorized)),\n+                new FileUploadProgressUpdateFunctionRegistry(new Mock<ILogger<FileUploadProgressUpdateFunctionRegistry>>().Object))\n+            { CallBase = false };\n+            \n+            mockService\n+                .Setup(s => s.DownloadFile(\n+                    It.IsAny<string>(),\n+                    It.IsAny<string>(),\n+                    It.IsAny<Func<FileDownloadProgress, Task>>(),\n+                    It.IsAny<CancellationToken>()))\n+                .ThrowsAsync(new UnauthorizedAccessException(\"Access to the path 'C:\\\\protected\\\\file.txt' is denied.\"));\n+\n+            var command = CreateCommand(mockService.Object);\n+            command.Source = \"file.txt\";\n+            command.Destination = @\"C:\\protected\\\";\n+\n+            // Act\n+            await command.Execute(CreateContext());\n+\n+            // Assert - Should display permission denied error, not generic \"Download failed\"\n+            _console.Output.Should().Contain(\"Permission denied:\", \"should display user-friendly permission error\");\n+            _console.Output.Should().NotContain(\"Download failed:\", \"should not show generic error for permission issues\");\n+        }\n+\n+        /// <summary>\n+        /// Implements: UX-020, EH-002, T130 (IMPL-130)\n+        /// When: InvalidOperationException with \"disconnected\" thrown during download\n+        /// Then: Display \"Connection lost during download\" error message\n+        /// </summary>\n+        [TestMethod]\n+        public async Task Execute_ConnectionLostViaInvalidOperation_DisplaysConnectionLostError()\n+        {\n+            // Arrange\n+            _proxyMock.Setup(p => p.ConnectionState).Returns(ServerProxyConnectionState.Connected);\n+            \n+            var mockService = new Mock<FileTransferService>(\n+                new Mock<ILogger<FileTransferService>>().Object,\n+                _proxyMock.Object,\n+                new Mock<IHttpClientFactory>().Object,\n+                TestAccessTokenManager.Create(new HttpResponseMessage(HttpStatusCode.Unauthorized)),\n+                new FileUploadProgressUpdateFunctionRegistry(new Mock<ILogger<FileUploadProgressUpdateFunctionRegistry>>().Object))\n+            { CallBase = false };\n+            \n+            mockService\n+                .Setup(s => s.DownloadFile(\n+                    It.IsAny<string>(),\n+                    It.IsAny<string>(),\n+                    It.IsAny<Func<FileDownloadProgress, Task>>(),\n+                    It.IsAny<CancellationToken>()))\n+                .ThrowsAsync(new InvalidOperationException(\"The client is disconnected\"));\n+\n+            var command = CreateCommand(mockService.Object);\n+            command.Source = \"file.txt\";\n+            command.Destination = @\"C:\\downloads\\\";\n+\n+            // Act\n+            await command.Execute(CreateContext());\n+\n+            // Assert - Should display connection lost error, not generic \"Download failed\"\n+            _console.Output.Should().Contain(\"Connection lost during download\", \"should display user-friendly connection error\");\n+            _console.Output.Should().NotContain(\"Download failed:\", \"should not show generic error for connection issues\");\n+        }\n+\n+        /// <summary>\n+        /// Implements: EH-003, T130 (IMPL-130)\n+        /// When: RemoteMessagingException thrown during download (SignalR disconnect)\n+        /// Then: Display \"Connection lost during download\" error message\n+        /// </summary>\n+        [TestMethod]\n+        public async Task Execute_ConnectionLostViaRemoteMessagingException_DisplaysConnectionLostError()\n+        {\n+            // Arrange\n+            _proxyMock.Setup(p => p.ConnectionState).Returns(ServerProxyConnectionState.Connected);\n+            \n+            var mockService = new Mock<FileTransferService>(\n+                new Mock<ILogger<FileTransferService>>().Object,\n+                _proxyMock.Object,\n+                new Mock<IHttpClientFactory>().Object,\n+                TestAccessTokenManager.Create(new HttpResponseMessage(HttpStatusCode.Unauthorized)),\n+                new FileUploadProgressUpdateFunctionRegistry(new Mock<ILogger<FileUploadProgressUpdateFunctionRegistry>>().Object))\n+            { CallBase = false };\n+            \n+            mockService\n+                .Setup(s => s.DownloadFile(\n+                    It.IsAny<string>(),\n+                    It.IsAny<string>(),\n+                    It.IsAny<Func<FileDownloadProgress, Task>>(),\n+                    It.IsAny<CancellationToken>()))\n+                .ThrowsAsync(new RemoteMessagingException(\"test-correlation-id\", \"SignalR connection closed\"));\n+\n+            var command = CreateCommand(mockService.Object);\n+            command.Source = \"file.txt\";\n+            command.Destination = @\"C:\\downloads\\\";\n+\n+            // Act\n+            await command.Execute(CreateContext());\n+\n+            // Assert - Should display connection lost error, not generic \"Download failed\"\n+            _console.Output.Should().Contain(\"Connection lost during download\", \"should display user-friendly connection error\");\n+            _console.Output.Should().NotContain(\"Download failed:\", \"should not show generic error for connection issues\");\n+        }\n+\n+        #endregion\n+\n         #region Progress Display Tests (UX-012, UX-013, UX-014)\n \n         /// <summary>\ndiff --git a/specs/007-download-command/batch-state.json b/specs/007-download-command/batch-state.json\nindex d586760..07b289f 100644\n--- a/specs/007-download-command/batch-state.json\n+++ b/specs/007-download-command/batch-state.json\n@@ -1,8 +1,8 @@\n {\n   \"featureDir\": \"specs/007-download-command\",\n   \"activeBatch\": \"batch-004\",\n-  \"currentTask\": null,\n-  \"batchStatus\": \"pending\",\n+  \"currentTask\": \"T130\",\n+  \"batchStatus\": \"in-progress\",\n   \"taskStates\": {\n     \"T001\": {\n       \"status\": \"verified\",\n@@ -557,10 +557,13 @@\n       \"phase\": \"verified\"\n     },\n     \"T129\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"verified\",\n+      \"status\": \"verified\",\n+      \"verifiedAt\": \"2026-01-14T09:36:35.6607125-06:00\"\n     },\n     \"T130\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"red\",\n+      \"status\": \"in-progress\"\n     },\n     \"T131\": {\n       \"phase\": \"pending\"\n@@ -572,7 +575,10 @@\n       \"phase\": \"pending\"\n     },\n     \"T098\": {\n-      \"phase\": \"pending\"\n+      \"status\": \"verified\",\n+      \"phase\": \"verified\",\n+      \"preCompleted\": true,\n+      \"note\": \"Covered by Execute_PermissionDenied_DisplaysPermissionDeniedError test added in T129\"\n     },\n     \"T099\": {\n       \"phase\": \"pending\"\n@@ -584,7 +590,10 @@\n       \"phase\": \"pending\"\n     },\n     \"T118\": {\n-      \"phase\": \"pending\"\n+      \"status\": \"verified\",\n+      \"phase\": \"verified\",\n+      \"preCompleted\": true,\n+      \"note\": \"Covered by Execute_PermissionDenied_DisplaysPermissionDeniedError test added in T129\"\n     },\n     \"T119\": {\n       \"phase\": \"pending\"\ndiff --git a/specs/007-download-command/batches/batch-004.md b/specs/007-download-command/batches/batch-004.md\nindex 05f74e2..09b589c 100644\n--- a/specs/007-download-command/batches/batch-004.md\n+++ b/specs/007-download-command/batches/batch-004.md\n@@ -1,7 +1,7 @@\n # Batch 004: US4 Implementation + Error Tests (Part 1)\n \n **Created**: 2026-01-11\n-**Status**: pending\n+**Status**: in-progress\n **Tasks**: 15\n **Type**: mixed (implementation + backfill)\n \n@@ -28,7 +28,7 @@ US4 implementation tasks and initial error handling tests that depend on them.\n \n ### US4 Implementation (First)\n \n-- [ ] T129 [depends:T103] @test-case:IMPL-129 Handle permission denied on local write in `DownloadCommand.cs`\n+- [X] T129 [depends:T103] @test-case:IMPL-129 Handle permission denied on local write in `DownloadCommand.cs`\n - [ ] T130 [depends:T103] @test-case:IMPL-130 Handle connection lost during download (cleanup partial file) in `DownloadCommand.cs`\n - [ ] T131 [depends:T103] @test-case:IMPL-131 Handle checksum verification failure in `DownloadCommand.cs`\n - [ ] T132 [depends:T103] @test-case:IMPL-132 Handle disk space exhausted in `DownloadCommand.cs`\n@@ -38,7 +38,8 @@ US4 implementation tasks and initial error handling tests that depend on them.\n \n - [X] T097 [depends:T036] @test-case:UX-018 Test file not found error for literal path in `DownloadCommandTests.cs`\n   > **Already exists**: `IntegrationTests_DownloadCommand.DownloadCommand_FileNotFound_ShowsError` tests literal path 404 handling E2E.\n-- [ ] T098 [depends:T129] @test-case:UX-019 Test permission denied error in `DownloadCommandTests.cs`\n+- [X] T098 [depends:T129] @test-case:UX-019 Test permission denied error in `DownloadCommandTests.cs`\n+  > **Already exists**: `DownloadCommandTests.Execute_PermissionDenied_DisplaysPermissionDeniedError` (added in T129) tests this.\n - [ ] T099 [depends:T130] @test-case:UX-020 Test connection lost error in `DownloadCommandTests.cs`\n - [X] T100 [depends:T131] @test-case:UX-021 Test checksum failure error in `DownloadCommandTests.cs`\n   > **Already exists**: `FileTransferServiceDownloadTests.DownloadFile_ChecksumMismatch_ThrowsInvalidDataException` (CV-013) tests this.\n@@ -46,7 +47,8 @@ US4 implementation tasks and initial error handling tests that depend on them.\n   > **Already exists**: `FileTransferServiceDownloadTests.DownloadFile_ChecksumMismatch_ThrowsInvalidDataException` verifies partial file cleanup. Also `PartialFileCleanupTests` for uploads.\n - [ ] T116 [depends:T130] @test-case:EH-002 Test connection lost cleanup and message in `DownloadCommandTests.cs`\n - [ ] T117 [depends:T130] @test-case:EH-003 Test SignalR disconnect handling in `DownloadCommandTests.cs`\n-- [ ] T118 [depends:T129] @test-case:EH-005 Test permission denied message in `DownloadCommandTests.cs`\n+- [X] T118 [depends:T129] @test-case:EH-005 Test permission denied message in `DownloadCommandTests.cs`\n+  > **Already exists**: `DownloadCommandTests.Execute_PermissionDenied_DisplaysPermissionDeniedError` (added in T129) tests this.\n - [ ] T119 [depends:T132] @test-case:EH-006 Test disk space exhausted handling in `DownloadCommandTests.cs`\n - [ ] T120 [depends:T133] @test-case:EH-007 Test path too long handling in `DownloadCommandTests.cs`\n \n@@ -58,3 +60,4 @@ All 15 tasks must be verified via `/speckit.verify` before batch advances.\n \n - Implementation tasks T129-T133 should be done first as tests depend on them\n - These are error handling paths ΓÇö ensure partial file cleanup is robust\n+"
  }
}
