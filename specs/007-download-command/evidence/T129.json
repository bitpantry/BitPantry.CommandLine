{
  "taskId": "T129",
  "testCase": "",
  "red": {
    "timestamp": "2026-01-14T09:35:14.3052104-06:00",
    "testCommand": "dotnet test --filter Execute_PermissionDenied_DisplaysPermissionDeniedError",
    "exitCode": 1,
    "output": "Expected Permission denied: but got Download failed:",
    "testFile": "BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs",
    "testMethod": "Execute_PermissionDenied_DisplaysPermissionDeniedError"
  },
  "green": {
    "timestamp": "2026-01-14T09:35:50.9141856-06:00",
    "testCommand": "dotnet test --filter Execute_PermissionDenied_DisplaysPermissionDeniedError",
    "exitCode": 0,
    "output": "Passed: 428, Failed: 0"
  },
  "diff": {
    "timestamp": "2026-01-14T09:35:50.9141856-06:00",
    "files": [
      "BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs",
      "BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs",
      "BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs",
      "specs/007-download-command/batch-state.json"
    ],
    "patch": "diff --git a/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs b/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\nindex 92d5d6f..373c81c 100644\n--- a/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\n+++ b/BitPantry.CommandLine.Remote.SignalR.Client/Commands/Server/DownloadCommand.cs\n@@ -129,6 +129,10 @@ namespace BitPantry.CommandLine.Remote.SignalR.Client.Commands.Server\n             {\n                 _console.MarkupLine($\"[red]File not found:[/] {Markup.Escape(ex.Message)}\");\n             }\n+            catch (UnauthorizedAccessException ex)\n+            {\n+                _console.MarkupLine($\"[red]Permission denied:[/] {Markup.Escape(ex.Message)}\");\n+            }\n             catch (Exception ex)\n             {\n                 _console.MarkupLine($\"[red]Download failed:[/] {Markup.Escape(ex.Message)}\");\ndiff --git a/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs b/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\nindex a30b4d7..961b02a 100644\n--- a/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\n+++ b/BitPantry.CommandLine.Remote.SignalR.Client/FileTransferService.cs\n@@ -195,7 +195,7 @@ namespace BitPantry.CommandLine.Remote.SignalR.Client\n         /// <exception cref=\"InvalidOperationException\">Thrown if the client is disconnected</exception>\n         /// <exception cref=\"FileNotFoundException\">Thrown if the remote file does not exist</exception>\n         /// <exception cref=\"InvalidDataException\">Thrown if the checksum verification fails</exception>\n-        public async Task DownloadFile(string remoteFilePath, string localFilePath, Func<FileDownloadProgress, Task> progressCallback, CancellationToken token = default)\n+        public virtual async Task DownloadFile(string remoteFilePath, string localFilePath, Func<FileDownloadProgress, Task> progressCallback, CancellationToken token = default)\n         {\n             if (_proxy.ConnectionState != ServerProxyConnectionState.Connected)\n                 throw new InvalidOperationException(\"The client is disconnected\");\ndiff --git a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\nindex 1851c78..1481ebf 100644\n--- a/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\n+++ b/BitPantry.CommandLine.Tests.Remote.SignalR/ClientTests/DownloadCommandTests.cs\n@@ -747,6 +747,49 @@ namespace BitPantry.CommandLine.Tests.Remote.SignalR.ClientTests\n \n         #endregion\n \n+        #region Error Handling Tests (UX-019, EH-005, T129)\n+\n+        /// <summary>\n+        /// Implements: UX-019, EH-005, T129 (IMPL-129)\n+        /// When: UnauthorizedAccessException thrown during local file write\n+        /// Then: Display \"Permission denied: [details]\" error message\n+        /// </summary>\n+        [TestMethod]\n+        public async Task Execute_PermissionDenied_DisplaysPermissionDeniedError()\n+        {\n+            // Arrange\n+            _proxyMock.Setup(p => p.ConnectionState).Returns(ServerProxyConnectionState.Connected);\n+            \n+            var mockService = new Mock<FileTransferService>(\n+                new Mock<ILogger<FileTransferService>>().Object,\n+                _proxyMock.Object,\n+                new Mock<IHttpClientFactory>().Object,\n+                TestAccessTokenManager.Create(new HttpResponseMessage(HttpStatusCode.Unauthorized)),\n+                new FileUploadProgressUpdateFunctionRegistry(new Mock<ILogger<FileUploadProgressUpdateFunctionRegistry>>().Object))\n+            { CallBase = false };\n+            \n+            mockService\n+                .Setup(s => s.DownloadFile(\n+                    It.IsAny<string>(),\n+                    It.IsAny<string>(),\n+                    It.IsAny<Func<FileDownloadProgress, Task>>(),\n+                    It.IsAny<CancellationToken>()))\n+                .ThrowsAsync(new UnauthorizedAccessException(\"Access to the path 'C:\\\\protected\\\\file.txt' is denied.\"));\n+\n+            var command = CreateCommand(mockService.Object);\n+            command.Source = \"file.txt\";\n+            command.Destination = @\"C:\\protected\\\";\n+\n+            // Act\n+            await command.Execute(CreateContext());\n+\n+            // Assert - Should display permission denied error, not generic \"Download failed\"\n+            _console.Output.Should().Contain(\"Permission denied:\", \"should display user-friendly permission error\");\n+            _console.Output.Should().NotContain(\"Download failed:\", \"should not show generic error for permission issues\");\n+        }\n+\n+        #endregion\n+\n         #region Progress Display Tests (UX-012, UX-013, UX-014)\n \n         /// <summary>\ndiff --git a/specs/007-download-command/batch-state.json b/specs/007-download-command/batch-state.json\nindex d586760..69c074f 100644\n--- a/specs/007-download-command/batch-state.json\n+++ b/specs/007-download-command/batch-state.json\n@@ -1,8 +1,8 @@\n {\n   \"featureDir\": \"specs/007-download-command\",\n   \"activeBatch\": \"batch-004\",\n-  \"currentTask\": null,\n-  \"batchStatus\": \"pending\",\n+  \"currentTask\": \"T129\",\n+  \"batchStatus\": \"in-progress\",\n   \"taskStates\": {\n     \"T001\": {\n       \"status\": \"verified\",\n@@ -557,7 +557,8 @@\n       \"phase\": \"verified\"\n     },\n     \"T129\": {\n-      \"phase\": \"pending\"\n+      \"phase\": \"red\",\n+      \"status\": \"in-progress\"\n     },\n     \"T130\": {\n       \"phase\": \"pending\""
  }
}
